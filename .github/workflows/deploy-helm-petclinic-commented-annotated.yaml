# GitHub Actions Workflow: Helm Chart ê¸°ë°˜ PetClinic ì•± ìë™ ë°°í¬ with EFS ì—°ë™
# ì´ ì›Œí¬í”Œë¡œëŠ” charts/petclinic/ ë””ë ‰í† ë¦¬ ë³€ê²½ ì‹œ ìë™ ì‹¤í–‰ë˜ë©°, ìˆ˜ë™ ì‹¤í–‰ë„ ê°€ëŠ¥í•©ë‹ˆë‹¤.
# ì£¼ìš” ì‘ì—…:
# - EKS í´ëŸ¬ìŠ¤í„° ì ‘ê·¼ ì„¤ì •
# - EFS ID ë™ì ìœ¼ë¡œ ì¡°íšŒ
# - Helm Chart ë°°í¬ ì‹œ EFS volumeHandle ìë™ ì£¼ì…

# ì´ ì›Œí¬í”Œë¡œì˜ ì´ë¦„ì…ë‹ˆë‹¤.
name: Deploy PetClinic via Helm

# ì›Œí¬í”Œë¡œê°€ ì‹¤í–‰ë  ì¡°ê±´ì„ ì •ì˜í•©ë‹ˆë‹¤.
on:
  # Helm Chart ë³€ê²½ ì‹œ ìë™ ì‹¤í–‰
# íŠ¹ì • íŒŒì¼ ë³€ê²½ ì‹œ ìë™ ì‹¤í–‰ë˜ë„ë¡ ì„¤ì •í•©ë‹ˆë‹¤.
  push:
# ì‹¤í–‰ì„ ìœ ë°œí•  íŒŒì¼ ê²½ë¡œë“¤ì„ ì§€ì •í•©ë‹ˆë‹¤.
    paths:
      - 'charts/petclinic/**'
  # GitHub UIì—ì„œ ìˆ˜ë™ ì‹¤í–‰ í—ˆìš©
# GitHubì—ì„œ ìˆ˜ë™ìœ¼ë¡œ ì‹¤í–‰í•  ìˆ˜ ìˆë„ë¡ í•©ë‹ˆë‹¤.
  workflow_dispatch:

# ì‹¤í–‰í•  ì‘ì—…(job)ì„ ì •ì˜í•©ë‹ˆë‹¤.
jobs:
  helm-deploy:
    # GitHub Actions ê¸°ë³¸ Linux í™˜ê²½ì—ì„œ ì‹¤í–‰
# ìµœì‹  Ubuntu í™˜ê²½ì—ì„œ ì‹¤í–‰ë˜ë„ë¡ ì§€ì •í•©ë‹ˆë‹¤.
    runs-on: ubuntu-latest

    steps:
    # ì†ŒìŠ¤ì½”ë“œ ì²´í¬ì•„ì›ƒ
# ì´ ë‹¨ê³„ì˜ ì´ë¦„ì„ ì •ì˜í•©ë‹ˆë‹¤.
    - name: Checkout repository
# ì¬ì‚¬ìš© ê°€ëŠ¥í•œ GitHub Actionì„ ì§€ì •í•©ë‹ˆë‹¤.
      uses: actions/checkout@v3

    # AWS ìê²© ì¦ëª… êµ¬ì„± (Secretsì— ë“±ë¡ëœ ê°’ ì‚¬ìš©)
# ì´ ë‹¨ê³„ì˜ ì´ë¦„ì„ ì •ì˜í•©ë‹ˆë‹¤.
    - name: Configure AWS credentials
# ì¬ì‚¬ìš© ê°€ëŠ¥í•œ GitHub Actionì„ ì§€ì •í•©ë‹ˆë‹¤.
      uses: aws-actions/configure-aws-credentials@v2
# í•´ë‹¹ ì•¡ì…˜ì— ì „ë‹¬í•  ë§¤ê°œë³€ìˆ˜ë¥¼ ì •ì˜í•©ë‹ˆë‹¤.
      with:
# GitHub Secretsì— ì €ì¥ëœ AWS ì•¡ì„¸ìŠ¤ í‚¤
        aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
# GitHub Secretsì— ì €ì¥ëœ AWS ë¹„ë°€ í‚¤
        aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        aws-region: ap-northeast-2

    # kubectl ì„¤ì¹˜
# ì´ ë‹¨ê³„ì˜ ì´ë¦„ì„ ì •ì˜í•©ë‹ˆë‹¤.
    - name: Set up kubectl
# ì¬ì‚¬ìš© ê°€ëŠ¥í•œ GitHub Actionì„ ì§€ì •í•©ë‹ˆë‹¤.
      uses: azure/setup-kubectl@v3
# í•´ë‹¹ ì•¡ì…˜ì— ì „ë‹¬í•  ë§¤ê°œë³€ìˆ˜ë¥¼ ì •ì˜í•©ë‹ˆë‹¤.
      with:
        version: v1.27.1

    # Helm ì„¤ì¹˜
# ì´ ë‹¨ê³„ì˜ ì´ë¦„ì„ ì •ì˜í•©ë‹ˆë‹¤.
    - name: Set up Helm
# ì¬ì‚¬ìš© ê°€ëŠ¥í•œ GitHub Actionì„ ì§€ì •í•©ë‹ˆë‹¤.
      uses: azure/setup-helm@v3
# í•´ë‹¹ ì•¡ì…˜ì— ì „ë‹¬í•  ë§¤ê°œë³€ìˆ˜ë¥¼ ì •ì˜í•©ë‹ˆë‹¤.
      with:
        version: v3.12.0

    # EKS í´ëŸ¬ìŠ¤í„° kubeconfig ì„¤ì •
# ì´ ë‹¨ê³„ì˜ ì´ë¦„ì„ ì •ì˜í•©ë‹ˆë‹¤.
    - name: Configure kubeconfig for EKS
      run: |
        aws eks --region ap-northeast-2 update-kubeconfig --name petclinic

    # Helm ë°°í¬: EFS ID ì¡°íšŒ í›„ Helmì— ë™ì  ì£¼ì…
# ì´ ë‹¨ê³„ì˜ ì´ë¦„ì„ ì •ì˜í•©ë‹ˆë‹¤.
    - name: Deploy PetClinic via Helm with dynamic EFS
      run: |
        kubectl create namespace petclinic --dry-run=client -o yaml | kubectl apply -f -

        EFS_ID=$(aws efs describe-file-systems \
          --query "FileSystems[?contains(Name, 'petclinic')].FileSystemId | [0]" \
          --region ap-northeast-2 --output text)

        echo "ğŸ“¦ Using EFS volumeHandle: $EFS_ID"

        helm upgrade --install petclinic ./charts/petclinic \
          -n petclinic \
          --set storage.volumeHandle=$EFS_ID